<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Address Sticker Printer</title>
    <link rel="stylesheet" href="/static/styles.css"/>
  </head>
  <body>
    <div class="container">
      <section class="hero">
        <div>
          <div class="lang-row">
            <h1>{{ tr('hero_title') }}</h1>
            <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
              {% for code in ['en','fr','nl','es','de','it'] %}
              <a href="/?lang={{ code }}" class="btn secondary {% if lang==code %}active{% endif %}">{{ code|upper }}</a>
              {% endfor %}
              <button id="toggle-theme" class="btn secondary" type="button" data-dark-label="{{ tr('dark_mode') }}" data-light-label="{{ tr('light_mode') }}">{{ tr('dark_mode') }}</button>
            </div>
          </div>
          <p>{{ tr('hero_desc') }}</p>
          {% if error %}<p style="color:#b91c1c; font-weight:600;">{{ error }}</p>{% endif %}
          <div class="badges">
            <span class="badge">{{ tr('badge_csv') }}</span><span class="badge">{{ tr('badge_avery') }}</span><span class="badge">{{ tr('badge_custom') }}</span><span class="badge">{{ tr('badge_pdf') }}</span>
          </div>
        </div>
        <div class="hero-card"><img src="/static/images/hero-labels.svg" alt="Address labels preview"/></div>
      </section>

      <h2 class="section-title">{{ tr('how_it_works') }}</h2>
      <div class="grid-3">
        <article class="card"><h3>{{ tr('step1_title') }}</h3><p>{{ tr('step1_desc') }}</p></article>
        <article class="card"><h3>{{ tr('step2_title') }}</h3><p>{{ tr('step2_desc') }}</p></article>
        <article class="card"><h3>{{ tr('step3_title') }}</h3><p>{{ tr('step3_desc') }}</p></article>
      </div>

      <h2 class="section-title">{{ tr('templates_preview') }}</h2>
      <div class="hero-card" style="margin-bottom:1rem;"><img src="/static/images/templates-preview.svg" alt="Avery templates preview"/></div>

      <section class="form-panel">
        <h2 style="margin-top:0;">{{ tr('generate_labels') }}</h2>
        <p class="help-text">{{ tr('need_example') }} <a href="/sample.csv">{{ tr('download_sample') }}</a></p>

        <form id="label-form" action="/preview" method="post" enctype="multipart/form-data">
          <input type="hidden" name="lang" value="{{ lang }}"/>
          <input type="hidden" name="csv_text" id="csv_text" value=""/>
          <div class="form-grid">
            <label>{{ tr('avery_template') }}
              <select name="template" id="template-select" onchange="toggleCustomFields()">
                {% for code in templates %}<option value="{{ code }}">{{ code }}</option>{% endfor %}
                <option value="CUSTOM">CUSTOM</option>
              </select>
            </label>
            <label>{{ tr('csv_file') }}
              <input id="csv_file" type="file" name="csv_file" accept=".csv,text/csv" style="position:absolute;left:-9999px;"/>
              <div class="file-picker">
                <button type="button" class="btn secondary" id="pick-file-btn">{{ tr('choose_file') }}</button>
                <span id="file-name" class="help-text">{{ tr('no_file_selected') }}</span>
              </div>
            </label>
            <label>{{ tr('sender_address') }}<textarea name="sender_address" rows="1" placeholder="Tyrex, 12 Dino Street, The Hague"></textarea></label>
            <label>{{ tr('font_family') }}
              <select name="font_family">
                <option value="Helvetica">Helvetica</option>
                <option value="Times-Roman">Times New Roman</option>
                <option value="Courier">Courier</option>
              </select>
            </label>
            <label>{{ tr('top_margin') }}<input name="top_margin" value="0"/></label>
            <label>{{ tr('right_margin') }}<input name="right_margin" value="0"/></label>
            <label>{{ tr('bottom_margin') }}<input name="bottom_margin" value="0"/></label>
            <label>{{ tr('left_margin') }}<input name="left_margin" value="0"/></label>
          </div>

          <div id="custom-fields" class="form-grid" style="display:none; margin-top:.8rem;">
            <label>{{ tr('rows') }} <input name="custom_rows" value="7"/></label>
            <label>{{ tr('columns') }} <input name="custom_cols" value="3"/></label>
            <label>{{ tr('label_width') }} <input name="custom_label_width_mm" value="63.5"/></label>
            <label>{{ tr('label_height') }} <input name="custom_label_height_mm" value="38.1"/></label>
            <label>{{ tr('pitch_x') }} <input name="custom_pitch_x_mm" value="66.7"/></label>
            <label>{{ tr('pitch_y') }} <input name="custom_pitch_y_mm" value="38.1"/></label>
            <label>{{ tr('origin_x') }} <input name="custom_origin_x_mm" value="7.1"/></label>
            <label>{{ tr('origin_y') }} <input name="custom_origin_y_mm" value="15.1"/></label>
          </div>

          <div class="actions"><button class="btn" type="submit">{{ tr('preview_labels') }}</button></div>
        </form>
      </section>
    </div>

    <script>
      function toggleCustomFields(){ const sel=document.getElementById('template-select'); const cf=document.getElementById('custom-fields'); cf.style.display=sel.value==='CUSTOM'?'grid':'none'; }
      toggleCustomFields();
      const btn=document.getElementById('toggle-theme');
      const saved=localStorage.getItem('theme');
      if(saved==='dark') document.body.classList.add('dark');
      function updateThemeButton(){
        const isDark=document.body.classList.contains('dark');
        btn.textContent=isDark?btn.dataset.lightLabel:btn.dataset.darkLabel;
      }
      updateThemeButton();
      btn.addEventListener('click',()=>{
        document.body.classList.toggle('dark');
        localStorage.setItem('theme',document.body.classList.contains('dark')?'dark':'light');
        updateThemeButton();
      });

      const fileInput = document.getElementById('csv_file');
      const pickBtn = document.getElementById('pick-file-btn');
      const fileName = document.getElementById('file-name');
      const csvText = document.getElementById('csv_text');
      const form = document.getElementById('label-form');
      const noFileTxt = {{ tr('no_file_selected')|tojson }};
      const fileRequiredTxt = {{ tr('file_required')|tojson }};

      pickBtn.addEventListener('click', ()=>fileInput.click());
      fileInput.addEventListener('change', async ()=>{
        const f = fileInput.files && fileInput.files[0];
        if(!f){ fileName.textContent = noFileTxt; return; }
        fileName.textContent = f.name;
        const text = await f.text();
        csvText.value = text;
        localStorage.setItem('csv_text_cache', text);
        localStorage.setItem('csv_name_cache', f.name);
      });

      const cachedText = localStorage.getItem('csv_text_cache');
      const cachedName = localStorage.getItem('csv_name_cache');
      if(cachedText){ csvText.value = cachedText; }
      if(cachedName){ fileName.textContent = cachedName + ' (cached)'; }

      form.addEventListener('submit', (e)=>{
        const hasFile = fileInput.files && fileInput.files.length > 0;
        const hasCached = !!csvText.value.trim();
        if(!hasFile && !hasCached){
          e.preventDefault();
          alert(fileRequiredTxt);
        }
      });

      {% if ga_measurement_id %}
      function initAnalytics(){ if(window.__gaLoaded) return; window.__gaLoaded=true; const s=document.createElement('script'); s.async=true; s.src='https://www.googletagmanager.com/gtag/js?id={{ ga_measurement_id }}'; document.head.appendChild(s); window.dataLayer=window.dataLayer||[]; function gtag(){dataLayer.push(arguments);} window.gtag=gtag; gtag('js', new Date()); gtag('config', '{{ ga_measurement_id }}'); }
      (function(){ const key='cookie_consent_v1'; const choice=localStorage.getItem(key); const banner=document.getElementById('cookie-banner'); const accept=document.getElementById('cookie-accept'); const reject=document.getElementById('cookie-reject'); if(choice==='accepted'){initAnalytics();} else if(choice!=='rejected'&&banner){banner.classList.add('show');} if(accept){accept.addEventListener('click',()=>{localStorage.setItem(key,'accepted'); banner&&banner.classList.remove('show'); initAnalytics();});} if(reject){reject.addEventListener('click',()=>{localStorage.setItem(key,'rejected'); banner&&banner.classList.remove('show');});}})();
      {% endif %}
    </script>
    {% if ga_measurement_id %}
    <div id="cookie-banner" class="cookie-banner" role="dialog" aria-live="polite" aria-label="Cookie consent"><div class="cookie-row"><div class="cookie-text">We use analytics cookies (Google Analytics) to understand traffic and improve this site. You can accept or reject analytics cookies.</div><div class="cookie-actions"><button id="cookie-reject" class="btn secondary" type="button">Reject</button><button id="cookie-accept" class="btn" type="button">Accept</button></div></div></div>
    {% endif %}
  </body>
</html>
